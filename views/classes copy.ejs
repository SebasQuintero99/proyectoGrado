<h1>Gestión de Clases</h1>

<!-- Mensaje de error (opcional) -->
<% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-danger" role="alert">
        <%= error %>
    </div>
<% } %>

<!-- Filtro y campo para guardar laboratorio -->
<form method="GET" action="/classes" id="filterForm" class="mb-4">
    <label for="id_laboratorio" class="form-label">Laboratorio</label>
    <select name="selectedLaboratory" id="id_laboratorio" class="form-select w-50" onchange="document.getElementById('filterForm').submit()" required>
        <option value="">Seleccione un laboratorio</option>
        <% laboratories.forEach(lab => { %>
            <option value="<%= lab.id_laboratorio %>" <%= selectedLaboratory == lab.id_laboratorio ? 'selected' : '' %>>
                <%= lab.nombre %>
            </option>
        <% }) %>
    </select>
</form>

<!-- Formulario de Agregar/Editar Clase -->
<% if (permittedRoutes.includes('/classes/add')) { %>
    <form action="<%= classToEdit ? '/classes/update' : '/classes/add' %>" method="POST" class="mb-4">
        <% if (classToEdit) { %>
            <input type="hidden" name="id_clase" value="<%= classToEdit.id_clase %>">
        <% } %>
        <input type="hidden" name="id_laboratorio" value="<%= selectedLaboratory %>">

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="id_asignatura" class="form-label">Asignatura</label>
                <select name="id_asignatura" id="id_asignatura" class="form-select" required>
                    <option value="">Seleccione una asignatura</option>
                    <% subjects.forEach(subject => { %>
                        <option value="<%= subject.id_asignatura %>" 
                            <%= classToEdit && classToEdit.id_asignatura === subject.id_asignatura ? 'selected' : '' %>>
                            <%= subject.nombre %> - <%= subject.docente_nombre || 'Sin profesor' %> - <%= subject.numero_curso %>
                        </option>
                    <% }) %>
                </select>
            </div>

            <div class="col-md-6 mb-3">
                <label for="dia_semana" class="form-label">Día de la Semana</label>
                <select name="dia_semana" id="dia_semana" class="form-select" required>
                    <option value="">Seleccione un día</option>
                    <option value="Lunes" <%= classToEdit && classToEdit.dia_semana === 'Lunes' ? 'selected' : '' %>>Lunes</option>
                    <option value="Martes" <%= classToEdit && classToEdit.dia_semana === 'Martes' ? 'selected' : '' %>>Martes</option>
                    <option value="Miércoles" <%= classToEdit && classToEdit.dia_semana === 'Miércoles' ? 'selected' : '' %>>Miércoles</option>
                    <option value="Jueves" <%= classToEdit && classToEdit.dia_semana === 'Jueves' ? 'selected' : '' %>>Jueves</option>
                    <option value="Viernes" <%= classToEdit && classToEdit.dia_semana === 'Viernes' ? 'selected' : '' %>>Viernes</option>
                    <option value="Sábado" <%= classToEdit && classToEdit.dia_semana === 'Sábado' ? 'selected' : '' %>>Sábado</option>
                </select>
            </div>

            <div class="col-md-6 mb-3">
                <label for="hora_inicio" class="form-label">Hora de Inicio</label>
                <input 
                    type="time" 
                    name="hora_inicio" 
                    id="hora_inicio" 
                    class="form-control" 
                    value="<%= classToEdit ? classToEdit.hora_inicio : '' %>" 
                    required>
            </div>

            <div class="col-md-6 mb-3">
                <label for="hora_fin" class="form-label">Hora de Fin</label>
                <input 
                    type="time" 
                    name="hora_fin" 
                    id="hora_fin" 
                    class="form-control" 
                    value="<%= classToEdit ? classToEdit.hora_fin : '' %>" 
                    required>
            </div>
        </div>

        <button type="submit" class="btn <%= classToEdit ? 'btn-warning' : 'btn-success' %>">
            <%= classToEdit ? 'Actualizar' : 'Agregar' %>
        </button>
        <% if (classToEdit) { %>
            <a href="/classes" class="btn btn-secondary mt-2">Cancelar</a>
        <% } %>
    </form>
<% } %>

<!-- Tabla de Clases -->
<table id="classes" class="table table-bordered text-center classes-table">
    <thead>
        <tr>
            <th class="hour-column">Horas</th>
            <th class="day-column">Lunes</th>
            <th class="day-column">Martes</th>
            <th class="day-column">Miércoles</th>
            <th class="day-column">Jueves</th>
            <th class="day-column">Viernes</th>
            <th class="day-column">Sábado</th>
        </tr>
    </thead>
    <tbody>
        <% 
            const horarios = [...new Set(classes.map(classItem => classItem.hora_inicio))].sort();

            horarios.forEach(hora => { 
        %>
            <tr>
                <td><%= hora %></td>

                <% ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'].forEach(dia => { 
                    const clase = classes.find(classItem => 
                        classItem.hora_inicio <= hora && classItem.hora_fin > hora && classItem.dia_semana === dia
                    );

                    if (clase) { %>
                        <td class="day-column" style="background-color: <%= clase.asignatura_color %>; color: black;">
                            <div class="d-flex justify-content-end">
                                <% if (permittedRoutes.includes('/classes/update')) { %>
                                    <a href="/classes?editId=<%= clase.id_clase %>" class="btn btn-primary btn-sm">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </a>
                                <% } %>
                                <% if (permittedRoutes.includes('/classes/delete')) { %>
                                    <button 
                                        class="btn btn-danger btn-sm delete-btn ms-1" 
                                        data-id="<%= clase.id_clase %>" 
                                        data-entity="classes">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                <% } %>
                            </div>
                            <div>
                                <strong><%= clase.asignatura_nombre %></strong><br>
                                <small><strong>N° curso:</strong> <%= clase.numero_curso %></small><br>
                                <small><strong>Docente: </strong><%= clase.docente_nombre || 'Sin profesor' %></small><br>
                                <small><strong>Horario: </strong><%= clase.hora_inicio %> - <%= clase.hora_fin %></small>
                            </div>
                        </td>
                    <% } else { %>
                        <td class="day-column">No hay clase</td>
                    <% } 
                }); %>
            </tr>
        <% }); %>
    </tbody>
</table>
<script src="/js/deleteHandler.js"></script>

<script>
    new DataTable('#classes', {
        paging: false,
        layout: {
            topStart: {
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: '<i class="fa fa-file-excel-o"></i> Excel',
                        titleAttr: 'Excel'
                    },
                    {
                        extend: 'pdfHtml5',
                        text: '<i class="fa fa-file-pdf-o"></i> PDF',
                        titleAttr: 'PDF'
                    }
                ]
            }
        }
    });
</script>